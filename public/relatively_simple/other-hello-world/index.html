<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Blog">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Understanding Atomics </title>
    <link rel="apple-touch-icon" sizes="57x57" href="https://blog.anubhav.io/ apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://blog.anubhav.io/ /apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://blog.anubhav.io/ /apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://blog.anubhav.io/ /apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://blog.anubhav.io/ /apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://blog.anubhav.io/ /apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://blog.anubhav.io/ /apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://blog.anubhav.io/ /apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://blog.anubhav.io/ /apple-icon-180x180.png">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="192x192" href="https://blog.anubhav.io/ /android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://blog.anubhav.io/ /favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="https://blog.anubhav.io/ /favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://blog.anubhav.io/ /favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" itemprop="about" content="">
    <meta name="keywords" itemprop="keywords" content="dinkleberg, theme, gutenberg, rust">
    <meta itemprop="headline" content="Anubhav&#x27;s Blog" />
    <meta itemprop="educationalUse" content="knowledge share" />
    <meta itemprop="copyrightYear" content="2023" />
    <meta property="og:title" content="Anubhav&#x27;s Blog Understanding Atomics ">
    <meta property="og:description" content=" Explains the basic of atomics in Rust. Comes with a bonus: spinlock implementation. ">
    <meta property="og:image" content="https:&#x2F;&#x2F;user-images.githubusercontent.com&#x2F;10289071&#x2F;40806112-dd79ae78-64f6-11e8-8f24-63f387d5bb8f.jpg">
    <meta property="og:url" content="https:&#x2F;&#x2F;blog.anubhav.io&#x2F;relatively_simple&#x2F;other-hello-world&#x2F;">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="og:site_name" content="Dinkleberg Theme">
    <meta name="twitter:image:alt" content="Understanding Atomics">

    
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600|Source+Code+Pro">
    <link rel="stylesheet" href="/site.css">
    </head>

<body>
<div  itemscope itemtype="http://schema.org/Organization">
</div>

    <header class="header">
        <div class="container">
            <a class="title" href="https:&#x2F;&#x2F;blog.anubhav.io">
                
                <h1>Anubhav&#x27;s Blog</h1>
            </a>
        </div>
    </header>

    <div class="container padding-header">
        
<article itemscope itemtype="http://schema.org/BlogPosting" class="post post-page">
    
    
    <meta itemprop="image" content="https:&#x2F;&#x2F;user-images.githubusercontent.com&#x2F;10289071&#x2F;40806112-dd79ae78-64f6-11e8-8f24-63f387d5bb8f.jpg">
    
    
    <aside class="post__sidebar">
        
        <a class="category" href="https://blog.anubhav.io/categories/data-type/">
            Data Type
        </a>
        
        <h1 class="title" itemprop="headline">Understanding Atomics</h1>
        <address itemprop="author" itemscope itemtype="https://schema.org/Person">
            <span itemprop="name">Anubhav Chaturvedi</span>
        </address>
        <div class="extra">
            
            Tags:
            
            <a href="https://blog.anubhav.io/tags/atomic/">atomic</a>
            
            
            
            ,
            
            
            
            
            <a href="https://blog.anubhav.io/tags/utils/">utils</a>
            
            
            
            e
            
            
            
            
            <a href="https://blog.anubhav.io/tags/bla/">bla</a>
            
            
            
            
            

            
        </div>
    </aside>
    <div itemprop="articleBody" class="post__content">
        <h1 id="abstract">Abstract</h1>
<p>In this post I will explain what are atomics and how to use them in rust.</p>
<h1 id="what-is-an-atomic-anyway">&quot;What is an 'atomic' anyway?&quot;</h1>
<p>Atomics are data types on which operations are indivisible,
or the indivisible operations by themselves. Indivisible here means that
the side effects of the operations are only observable when the operation
is done. Generally, machines provide read and write operations over its
native integer both indivisible and divisible.</p>
<h1 id="atomics-in-rust">Atomics in Rust</h1>
<p>Currently (rust nightly 1.28 and stable 1.26) these atomic data types were
stabilized: <code>AtomicPtr&lt;T&gt;</code>, <code>AtomicUsize</code>, <code>AtomicIsize</code> and <code>AtomicBool</code>.
They are all located in <code>core::sync::atomic</code> (or <code>std::sync::atomic</code>).
To explain, I will pick the simplest one: <code>AtomicBool</code>.</p>
<h2 id="atomicbool"><code>AtomicBool</code></h2>
<p>It is very simple to create one:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> atomic_bool = AtomicBool::new(</span><span style="color:#d08770;">true</span><span>);
</span></code></pre>
<p>Now let's make an atomic read. But wait... uh oh... <code>AtomicBool::load</code>
accepts two arguments: san immutable reference to <code>self</code> and another
argument of type <code>Ordering</code>. The reference to <code>self</code> is easily understandable
but what about <code>Ordering</code>? <code>Ordering</code> is a type which determinates the...
the... order? Yes, the order related to other operations and other threads.
Let's see the definition of <code>Ordering</code>:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">pub enum </span><span>Ordering {
</span><span>    Relaxed,
</span><span>    Release,
</span><span>    Acquire,
</span><span>    AcqRel,
</span><span>    SeqCst,
</span><span>    </span><span style="color:#65737e;">// some variants omitted
</span><span>}
</span></code></pre>
<p>There are, roughly speaking, two kinds of CPUs related to orderings: the weak
and the strong. The weak processors have naturally weak guarantees on the
orderings, while the strong processors have naturally strong guarantees on the
orderings. It is generally low-cost for strong-processors to perform <code>Acquire</code>,
<code>Relase</code> and <code>AcqRel</code>, while they are high-cost for weak-processors. For all
of them <code>Relaxed</code> is low-cost and <code>SeqCst</code> is high-cost. Examples of weak-
processors are ARM-archs, and examples of strong-processors are the ones
x86/x86_64-archs.</p>
<p>The only valid variants for <code>load</code> to be called with are: <code>Relaxed</code>, <code>Acquire</code>
and <code>SeqCst</code>. Don't worry, the other variants will be explained later. <code>Relaxed</code>
is somewhat like &quot;the order does not matter at all&quot;. This allows both
the compiler and the CPU to reorder the operation. <code>SeqCst</code> means &quot;sequentially
consistent&quot;; it should not be reordered at all! Everything before it happens
before it, and everything after it happens after it.</p>
<p><code>Acquire</code> is a bit more complex. It is the &quot;complement&quot; of <code>Release</code>.
Everything (generally <code>store</code>s) that happens after the <code>Acquire</code> stays after
it. But the compiler and the CPU are free to reorder anything that happens
before it. It is designed to be used with <code>load</code>-like operations when acquiring
locks.</p>
<p>Let's see an example with <code>AtomicBool::load</code>:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>std::sync::atomic::{
</span><span>    AtomicBool,
</span><span>    Ordering::*,
</span><span>};
</span><span>
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">print_if_it_is</span><span>(</span><span style="color:#bf616a;">atomic</span><span>: &amp;AtomicBool) {
</span><span>    </span><span style="color:#b48ead;">if</span><span> atomic.</span><span style="color:#96b5b4;">load</span><span>(Acquire) {
</span><span>        println!(&quot;</span><span style="color:#a3be8c;">It is!</span><span>&quot;);
</span><span>    }
</span><span>}
</span></code></pre>
<p>Let's jump into the next operation: <code>store</code>. <code>store</code> accepts a reference to
<code>self</code>, the new value (of type <code>bool</code>), and an <code>Ordering</code>. The valid
<code>Ordering</code>s are <code>Relaxed</code>, <code>Release</code> and <code>SeqCst</code>. <code>Release</code>, as said before,
is used as a pair with <code>Acquire</code>. Everything before <code>Release</code> it happens before
it, but the compiler and the CPU are free to reorder anything that happens
after it. It is intended to be used when releasing a lock.</p>

    </div>
</article>


        <aside class="sidebar">
            <h3>Social</h3>
            <ul class="base-list">
                <li>
                    <a href="https:&#x2F;&#x2F;github.com&#x2F;anubhavchaturvedi">Github</a>
                </li>
                
                <li>
                    <a href="https:&#x2F;&#x2F;photography.anubhav.io&#x2F;">Photography</a>
                </li>
                
            </ul>
        </aside>
        
    </div>
</body>

</html>